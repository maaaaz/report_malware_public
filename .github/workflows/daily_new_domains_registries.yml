name: Daily scans of daily new domain names from DNS registries 

on:
  schedule:
    - cron:  '00 01 * * *'

jobs:
  DNS_registries:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        ssh-key: ${{ secrets.SSH_PRIVKEY_TO_REPORT_PRIVATE }}
        repository: maaaaz/report_malware
        path: ./REPORT_MALWARE_PRIVATE
    
    - name: Set $REPORT_MALWARE_PRIVATE environment variable for the rest of the workflow
      run: echo "REPORT_MALWARE_PRIVATE=$GITHUB_WORKSPACE/REPORT_MALWARE_PRIVATE" >> $GITHUB_ENV
    
    - name: What time is it ?
      run: |
        date -u
        TZ="Europe/Paris" date
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install resolver dependencies and download the script
      run: |
        python -m pip install --upgrade pip
        pip install csvkit
        
        cd /tmp/
        wget -nv https://github.com/maaaaz/red.flag.domains-publications/raw/main/_resources/resolver.py
        wget -nv https://github.com/maaaaz/red.flag.domains-publications/raw/main/_resources/resolver_requirements.txt
        pip install -r ./resolver_requirements.txt
        
    - name: Download AFNIC daily data
      run: |
        cd /tmp/
        wget -nv https://www.afnic.fr/wp-media/ftp/domaineTLD_Afnic/$(date --date='yesterday' '+%Y%m%d')_CREA_{fr,re,pm,tf,wf,yt}.txt
        cat *_CREA_*  | grep -Pv '^#' | sort -u | grep --color=none . > new_ICANN_domains
     
    - name: Resolve data
      run: |
        cd /tmp/
        ls -alh new_ICANN_domains
        
        # testing
        #echo 'toto.fr' > ./new_ICANN_domains
        
        python -Wall resolver.py -i ./new_ICANN_domains -o ./new_ICANN_domains.csv
        SQLALCHEMY_SILENCE_UBER_WARNING=1 csvsql -u 1 ./new_ICANN_domains_resolved.csv --tables db --query 'SELECT netloc_idna_decoded FROM db WHERE (ipv4 IS NOT NULL) OR (ipv6 IS NOT NULL)' | sed 1d > /tmp/new_ICANN_domains_with_existing_IPv4_or_IPv6
        split --numeric-suffixes=1 -n 7 "./new_ICANN_domains_with_existing_IPv4_or_IPv6" new_ICANN_domains_with_existing_IPv4_or_IPv6
    
    - name: Git pull $REPORT_MALWARE_PRIVATE
      run: |
        cd $REPORT_MALWARE_PRIVATE
        git pull --ff-only
        
    - name: Install Netcraft dependencies and download the script
      run: |
        cd /tmp/
        wget -nv "https://github.com/maaaaz/red.flag.domains-publications/raw/main/_resources/netcraft.py"
        wget -nv "https://github.com/maaaaz/red.flag.domains-publications/raw/main/_resources/netcraft_requirements.txt"
        pip install -r ./netcraft_requirements.txt
        
    - name: Submit to Netcraft
      continue-on-error: true
      env:
        SECRET_NETCRAFT_REPORT_MAIL: ${{ secrets.SECRET_NETCRAFT_REPORT_MAIL }}
        
      run: |
        cd $REPORT_MALWARE_PRIVATE
        git pull --ff-only
        
        TODAY_NETCRAFT_SUBS_DIR=$REPORT_MALWARE_PRIVATE/$(date '+%Y/%m/%Y-%m-%d/netcraft')
        mkdir -p "$TODAY_NETCRAFT_SUBS_DIR"
        TODAY_NETCRAFT_SUBS_FILE=$TODAY_NETCRAFT_SUBS_DIR/submissions.txt
                
        cd /tmp/
        TZ="Europe/Paris" date
        (TZ="Europe/Paris" date && python /tmp/netcraft.py -a submit -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv6";) >> $TODAY_NETCRAFT_SUBS_FILE
        
        # -- git stuff
        cd $REPORT_MALWARE_PRIVATE
        git config user.name netcraft-subs-bot
        git config user.email github-actions@github.com
        git add $TODAY_NETCRAFT_SUBS_FILE
        git commit -m "netcraft sub of ICANN daily new domains" $TODAY_NETCRAFT_SUBS_FILE
        git pull --rebase
        git push
        
    - name: Submit to CRDF
      env:
        SECRET_CRDF_API_KEY: ${{ secrets.SECRET_CRDF_API_KEY }}
        
      run: |
        cd /tmp/
        wget -nv "https://github.com/maaaaz/red.flag.domains-publications/raw/main/_resources/crdf.py"
        wget -nv "https://github.com/maaaaz/red.flag.domains-publications/raw/main/_resources/crdf_requirements.txt"
        pip install -r ./crdf_requirements.txt
        python /tmp/crdf.py -a submit -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv6"  
    
    - name: Install urlscan dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r $REPORT_MALWARE_PRIVATE/urlscan.io/requirements.txt
    
    - name: Scan to urlscan.io #1
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_01 }}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_01 }}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv601" -a submit > /dev/null &
        
    - name: Scan to urlscan.io #2
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_02 }}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_02 }}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv602" -a submit > /dev/null &
        
    - name: Scan to urlscan.io #3
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_03 }}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_03 }}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv603" -a submit > /dev/null &
        
    - name: Scan to urlscan.io #4
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_04 }}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_04 }}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv604" -a submit > /dev/null &
        
    - name: Scan to urlscan.io #5
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_05 }}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_05 }}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv605" -a submit > /dev/null &
        
    - name: Scan to urlscan.io #6
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_06 }}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_06 }}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv606" -a submit > /dev/null &
        
    - name: Scan to urlscan.io #7
      env: 
        SECRET_URLSCANIO_API_KEY: ${{ secrets.SECRET_URLSCANIO_API_KEY_ICANN_DAILY_07}}
        SECRET_URLSCANIO_LOGIN: ${{ secrets.SECRET_URLSCANIO_LOGIN_ICANN_DAILY_07}}
        SECRET_URLSCANIO_PASSWORD: ${{ secrets.SECRET_URLSCANIO_PASSWORD }}
                
      run: |
        cd $REPORT_MALWARE_PRIVATE
        python "$REPORT_MALWARE_PRIVATE/urlscan.io/urlscan_io.py" -i "/tmp/new_ICANN_domains_with_existing_IPv4_or_IPv607 -a submit > /dev/null
